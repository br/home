#!/bin/bash

#/ NAME
#/     proxy -- proxies deploy using a gateway host
#/
#/ SYNOPSIS
#/     
#/     proxy gateway version deploy_command args 
#/

# figure out the project root under which bin, lib live
shome="$(cd -P -- "$(dirname -- "$0")/.." && pwd -P)"

# load a meat library
source "$shome/bin/_prime" "$@"

# entry point
function main {
  local nm_component="$1"; shift
  case "$nm_component" in 
    *)
      local hst_proxy="$nm_component"
      local ver_repo="$1"; shift

      # remote arguments
      local git_url="$(git config --list | grep remote.origin.url | cut -d= -f2-)"

      local git_branch
      local git_head

      if [[ "$ver_repo" != "HEAD" ]]; then
        git_branch=""
        git_head="$ver_repo"
      else
        local git_ref=$(cat .git/HEAD)
        if echo "$git_ref" | egrep -q "^ref:"; then
          git_branch=$(echo "$git_ref" | awk '{print $2}' | cut -d/ -f3-)
          git_head=$(git show-ref --hash "$(echo "$git_ref" | awk '{print $2}')")
        else
          git_branch=""
          git_head=$git_ref
        fi
      fi

      if [[ -z $git_head ]]; then
        echo "ERROR: could not find the SHA for HEAD" 1>&2
        exit 1
      fi

      local pth_rvmrun="$(ruby -ryaml -e 'puts YAML.load(File.read(ARGV[0]))[ARGV[1]]' $shome/config/deploy.yml ruby_loader)"
      local nm_ruby="$(ruby -ryaml -e 'puts YAML.load(File.read(ARGV[0]))[ARGV[1]]' $shome/config/deploy.yml deploy_ruby)"
      cat $shome/bin/remote-helper | ssh $hst_proxy "$pth_rvmrun" "$nm_ruby" bash -s "$USER" "$git_url" "$git_branch:$git_head" "$@"
      ;;
  esac
}

# define command line options:
#   var name, default, description, short option

# parse the command-line
parse_command_line "$@" || exit $?
eval set -- "${FLAGS_ARGV}"

# pass arguments to entry point
main "$@"
