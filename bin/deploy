#!/bin/bash

#/ NAME
#/     deploy -- central script for alpha_omega commands
#/
#/ SYNOPSIS
#/     
#/     deploy
#/     stage
#/     activate
#/     restart
#/     rollback
#/     release
#/
#/     bump 
#/         major|minor|patch
#/         [1.2.3]
#/         * without arguments, defaults to patch 
#/     migrate 
#/         list | [data|pre|during|post]
#/         [YYYYMMDDHHMMSS]
#/         [any_task]
#/     compare
#/
#/     repl [host]
#/
#/     check
#/     plan
#/
#/     hosts
#/         [group] | [host]
#/         all | world
#/     dna
#/     shell
#/     invoke
#/         [command_and_args]
#/     debug
#/
#/     lock
#/         compare|migrate
#/     unlock
#/         compare|migrate

# figure out the project root under which bin, lib live
shome="$(cd -P -- "$(dirname -- "$0")/.." && pwd -P)"

# load a meat library
source "$shome/bin/_prime" "$@"

# entry point
function main {
  export BUNDLE_GEMFILE="$shome/.deploy/Gemfile"

  bundle check 2>&1 >/dev/null || { bundle install --quiet --local --path vendor/bundle || bundle check > /dev/null; }
  exec bundle exec alpha_omega $(basename $0) "$@"
}

# parse the command-line
parse_command_line "$@" || exit $?
eval set -- "${FLAGS_ARGV}"

# pass arguments to entry point
main "$@"
