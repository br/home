#!/bin/bash -e

function crumb {
  if [[ -n "$fl_debug" ]]; then
    echo "$(date) $@" 1>&2
  fi
}

nm_deployer=$1; shift
git_url=$1; shift
git_spec=$1; shift
cmd_deploy=$1; shift

if [[ "$cmd_deploy" = "debug" ]]; then
  fl_debug=1
else
  fl_debug=
fi

crumb "start bin/remote-helper"  

unset cd # disable rvm's cd function to prevent prompts

git_branch=$(echo $git_spec | cut -d: -f1)
git_sha=$(echo $git_spec | cut -d: -f2)

mkdir -p "$HOME/.deploy/$nm_deployer"
cd "$HOME/.deploy/$nm_deployer"

nm_project=$(basename $git_url .git)
if [[ ! -d $nm_project ]]; then
  crumb "git clone $git_url"
  git clone -q $git_url
fi

cd $nm_project
crumb "git fetch"
git fetch -q

crumb "git reset, checkout"
if [[ -z $git_branch || $git_branch = $git_sha ]]; then
  git reset -q --hard $git_sha
  git checkout -q $git_sha
else
  git checkout -q --force $git_branch
  git reset -q --hard $git_sha
fi

crumb "git submodule"
git submodule -q update --init --recursive

crumb "executing bin/$cmd_deploy $@"
export AO_USER="$nm_deployer"
bin/$cmd_deploy "$@"
crumb "end bin/remote-helper"
